<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tabirly | Tarot Tool v4.4</title>
<meta name="description" content="Tabirly tarot a√ßƒ±lƒ±mlarƒ±: Tek Kart, 3 Kart, Kelt Ha√ßƒ±, ƒ∞li≈üki A√ßƒ±lƒ±mƒ±. Se√ßmeli mod, payla≈üƒ±m, localStorage, g√∂rsel indir, TR/EN, tema." />
<meta property="og:title" content="Tabirly | Tarot Tool" />
<meta property="og:description" content="Tek Kart, 3 Kart, Kelt Ha√ßƒ±, ƒ∞li≈üki a√ßƒ±lƒ±mƒ±‚Äîsonucu link ve g√∂rsel olarak payla≈ü." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://tarot.tabirly.com" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%237f5af0'/><stop offset='1' stop-color='%23ffd166'/></linearGradient></defs><rect rx='14' width='64' height='64' fill='url(%23g)'/></svg>">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<style>
:root{
  /* Dark (varsayƒ±lan) pastel */
  --bg:#0e1118; --bg2:#111828; --card:#161b2a;
  --ink:#eef3ff; --muted:#9fb0c7;
  --acc1:#7fb8ff; --acc2:#79e9d3; --acc3:#b79cff;

  --radius:14px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
  --card-pad:10px; --title-size:14px; --mini-size:11px; --badge-size:11px;
}

/* Genel */
*{box-sizing:border-box}
body{
  margin:0;
  background: radial-gradient(1000px 700px at 15% -10%, var(--bg2) 0%, var(--bg) 55%), var(--bg);
  color:var(--ink);
  font:15px/1.6 system-ui, Inter, Roboto, Arial, sans-serif;
}
.wrap{max-width:1000px;margin:24px auto;padding:0 12px 64px}
header{display:flex;gap:12px;align-items:center;margin:0 0 12px}
.logo{width:38px;height:38px;border-radius:10px;background:conic-gradient(from 0deg, var(--acc3), var(--acc1), var(--acc2), var(--acc3))}
.hgroup h1{margin:0;font-size:20px}
.hgroup p{margin:.25rem 0 0;color:var(--muted);font-size:13px}

.panel{background:rgba(22,27,42,.65);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
.controls{display:grid;grid-template-columns:1fr 1fr auto;gap:var(--gap);align-items:end}
@media(max-width:700px){.controls{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
select,input{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0f1423;color:var(--ink);padding:8px 9px;font:inherit}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}

.btn{border:0;border-radius:12px;padding:10px 14px;background:linear-gradient(180deg, var(--acc1), var(--acc2));color:#0c0f14;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(127,184,255,.25)}
.btn.small{padding:7px 10px;font-weight:600}

/* GRID + Kart */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:var(--gap);margin:14px 0;justify-items:center}
#board[data-type="celtic"]{grid-template-columns:repeat(5,1fr)}
@media (max-width:900px){#board[data-type="celtic"]{grid-template-columns:repeat(3,1fr)}}
#board[data-type="relation"]{grid-template-columns:repeat(3,1fr)}

.tarot-card{
  position:relative; aspect-ratio:3/5; border-radius:12px;
  transform-style:preserve-3d; transition:transform .65s cubic-bezier(.2,.6,.2,1);
  box-shadow:var(--shadow); cursor:pointer; will-change:transform;
  width:100%; max-width:120px; justify-self:center; /* k√º√ß√ºk */
}
.tarot-card.flipped{transform:rotateY(180deg)}
.tarot-card .face{position:absolute;inset:0;display:grid;place-items:center;backface-visibility:hidden;border-radius:12px;overflow:hidden}
.tarot-card .back{
  background:
    linear-gradient(135deg, rgba(127,184,255,.18), rgba(121,233,211,.12)),
    repeating-radial-gradient(circle at 50% 38%, #202744 0 7px, #1a2240 7px 14px);
}
.tarot-card .front{
  transform:rotateY(180deg);
  background:var(--card);
  padding:var(--card-pad);
  text-align:center;
  border:1px solid rgba(255,255,255,.08);
  position:relative;
}
.tarot-card .front img.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.26;filter:contrast(1.05) saturate(1.05) brightness(.9)}
.title{font-weight:800;margin-top:6px;font-size:var(--title-size)}
.mini{font-size:var(--mini-size);color:var(--muted);margin-top:3px}

.pos-badge,.rev-badge{position:absolute;top:6px;padding:3px 7px;border-radius:9px;font-size:var(--badge-size)}
.pos-badge{left:6px;background:rgba(0,0,0,.45);color:#fff}
.rev-badge{right:6px;background:rgba(239,71,111,.92);color:#fff;display:none}
.tarot-card.is-reversed .rev-badge{display:inline-block}
.tarot-card.is-reversed .front img.bg{transform:rotate(180deg)}

@keyframes shuffleSpin{0%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}100%{transform:rotate(0)}}
.shuffle .tarot-card{animation:shuffleSpin .22s ease both}

footer{margin-top:22px;color:var(--muted);font-size:11px;text-align:center}
.inline{display:flex;align-items:center;gap:8px}
.muted{color:var(--muted);font-size:12px}

/* Light tema */
[data-theme="light"]{
  --bg:#f4f7ff; --bg2:#ecf4ff; --card:#ffffff; --ink:#0b0d12; --muted:#4a5a70;
  --acc1:#B3D8FF; --acc2:#B6F2E3; --acc3:#D5C6FF;
  --shadow:0 8px 20px rgba(15,23,42,.08);
}
[data-theme="light"] body{
  background: radial-gradient(1000px 700px at 18% -10%, var(--bg2) 0%, var(--bg) 60%), var(--bg);
}
[data-theme="light"] .panel{background:#ffffffcc;border:1px solid rgba(15,23,42,.06)}
[data-theme="light"] select, [data-theme="light"] input{background:#ffffff;color:var(--ink);border:1px solid rgba(15,23,42,.12)}
[data-theme="light"] .btn{background:linear-gradient(180deg, var(--acc1), var(--acc3));color:#091016;box-shadow:0 6px 16px rgba(181,209,255,.35)}
[data-theme="light"] .tarot-card .back{
  background:
    linear-gradient(135deg, rgba(179,216,255,.45), rgba(214,198,255,.35)),
    repeating-radial-gradient(circle at 50% 38%, #e8efff 0 7px, #dee9ff 7px 14px);
}
[data-theme="light"] .tarot-card .front{background:linear-gradient(180deg,#ffffff,#f7f9ff);border:1px solid rgba(15,23,42,.08)}
[data-theme="light"] .pos-badge{background:rgba(9,16,22,.08);color:#091016}

/* Uzun yorumlar paneli */
#longReads h3{margin:0 0 10px;font-size:16px;color:var(--acc1)}
#longList .item{margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.08)}
#longList .title{font-weight:700;margin-bottom:4px}
#longList .body{font-size:14px;line-height:1.55}
[data-theme="light"] #longList .item{border-color:rgba(15,23,42,.1)}

/* Selectler kompakt */
.compact-select{width:auto}
select{appearance:auto}
@media (max-width:700px){.tarot-card{max-width:100px}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      
      <div class="hgroup">
        <h1>Tabirly Tarot </h1>
        <p>Tek Kart, 3 Kart, Kelt Ha√ßƒ±, ƒ∞li≈üki ‚Ä¢ Se√ßmeli mod ‚Ä¢ Payla≈ü/G√∂rsel ‚Ä¢ LocalStorage(Yani bilgileriniz bize hi√ß ula≈ümƒ±yor) ‚Ä¢ TR/EN ‚Ä¢ Tema</p>
      </div>
    </header>

    <section class="panel" aria-label="A√ßƒ±lƒ±m Ayarlarƒ±">
      <div class="controls">
        <div>
          <label for="spread">A√ßƒ±lƒ±m t√ºr√º</label>
          <select id="spread">
            <option value="one">Tek Kart</option>
            <option value="three">3 Kart (Ge√ßmi≈ü‚Äì≈ûimdi‚ÄìGelecek)</option>
            <option value="celtic">Kelt Ha√ßƒ± (10 kart)</option>
            <option value="relation">ƒ∞li≈üki A√ßƒ±lƒ±mƒ± (6 kart)</option>
          </select>
        </div>
        <div>
          <label for="question">Soru (isteƒüe baƒülƒ±)</label>
          <input id="question" type="text" placeholder="√ñrn. ƒ∞li≈ükimde nasƒ±l ilerlemeliyim?">
        </div>
        <div>
          <button id="deal" class="btn">Kartlarƒ± √áek</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="inline"><input type="checkbox" id="allowReversed" checked style="accent-color:#ffd166"/> Ters kart</label>
        <label class="inline"><input type="checkbox" id="autoFlip" checked style="accent-color:#ffd166"/> Otomatik flip</label>
        <label class="inline"><input type="checkbox" id="showImages" style="accent-color:#ffd166"/> Kart g√∂rselleri</label>
        <label class="inline"><input type="checkbox" id="pickMode" style="accent-color:#ffd166"/> Se√ßmeli mod</label>

        <label class="inline">Dil:
          <select id="lang" class="compact-select">
            <option value="tr">T√ºrk√ße</option>
            <option value="en">English</option>
          </select>
        </label>

        <label class="inline">Tema:
          <select id="theme" class="compact-select">
            <option value="dark">Koyu</option>
            <option value="light">A√ßƒ±k</option>
          </select>
        </label>
      </div>

    </section>

    <section class="panel" id="extras">
      <div class="row" id="sharebar" hidden>
        <button class="btn small" id="copyLink">Linki kopyala</button>
        <button class="btn small secondary" id="shareWa">WhatsApp</button>
        <button class="btn small secondary" id="shareX">X / Twitter</button>
        <button class="btn small" id="savePng">G√∂rsel indir (PNG)</button>
      </div>
    </section>

    <section id="deck" class="grid" hidden aria-label="Deste"></section>
    <section id="board" class="grid" aria-live="polite" aria-busy="false"></section>

    <section id="explain" class="panel" hidden>
      <p id="summary">Kartlara tƒ±klayarak √ßevir. Ayarlardan ters kartƒ± ve otomatik flip‚Äôi y√∂net. Se√ßmeli mod a√ßƒ±kken, desteden sƒ±rasƒ±yla gerekli sayƒ±da kart se√ß.</p>
    </section>

    <!-- üîΩ Uzun yorumlar buraya gelecek -->
    <section id="longReads" class="panel" hidden>
      <h3>Uzun Yorumlar</h3>
      <div id="longList"></div>
    </section>

    <footer><p>¬© Tabirly ‚Äî Tarot Tool v4.4</p></footer>
  </div>

<script>
/* ---------- Tarot veri seti (uzun yorumlu) ---------- */
const TAROT=(()=>{const U=(u,r,ul='',rl='')=>({upright:u,reversed:r,longU:ul||u,longR:rl||r});const majors={
"The Fool":U("Ba≈ülangƒ±√ß, cesaret, akƒ±≈üa g√ºven","D√º≈ü√ºncesizlik, hazƒ±rlƒ±ksƒ±z risk","Yeni bir sayfa; √ßocuk merakƒ±yla adƒ±m. Korku yerine deneyim ve √∂ƒürenme.","Plansƒ±z atƒ±lƒ±mƒ±n bedeli olabilir; √∂nce niyetini netle."),
"The Magician":U("Niyet, odak, eylem g√ºc√º","Daƒüƒ±lan enerji, yanƒ±lsama","Kaynaklarƒ±nƒ± tek bir hedefe hizala; s√∂yle-d√º≈ü√ºn-yap uyumu.","Hokkabazlƒ±k ve daƒüƒ±nƒ±k g√ºndem sonu√ß vermez; odaƒüƒ±nƒ± topla."),
"The High Priestess":U("Sezgi, sƒ±r, i√ße d√∂n√º≈ü","Gizlilik, kopukluk","Cevap i√ßerde; sessizlikte bilgi a√ßƒ±lƒ±r.","A≈üƒ±rƒ± i√ßine kapanma ileti≈üimi zayƒ±flatƒ±r."),
"The Empress":U("Bereket, bakƒ±m, yaratƒ±m","A≈üƒ±rƒ± koruma, tƒ±kanma","√úret, besle, b√ºy√ºt; doƒüa ritmi.","A≈üƒ±rƒ± sahiplenme yaratƒ±mƒ± boƒüuyor olabilir."),
"The Emperor":U("D√ºzen, yapƒ±, otorite","Katƒ±lƒ±k, kontrol","Sƒ±nƒ±r, kural ve strateji; liderlik.","Esneklik eksikliƒüi √ßatƒ±≈üma doƒüurur."),
"The Hierophant":U("Gelenek, rehberlik","K√∂r uyum, dogma","Usta-√ßƒ±rak bilgisi; rit√ºel faydalƒ±.","Sƒ±rf gelenek diye tutunma."),
"The Lovers":U("Se√ßim, uyum, baƒü","Kararsƒ±zlƒ±k, uyumsuzluk","Kalp-zihin hizasƒ±yla se√ßim.","Belirsizlik baƒüa zarar verir; netle≈ü."),
"The Chariot":U("ƒ∞rade, y√∂n, zafer","Dengesizlik","Tek y√∂ne √ßek; dizginler sende.","Hƒ±z var, denge yoksa savrulursun."),
"Strength":U("Sakin g√º√ß, sabƒ±r","Sabƒ±rsƒ±zlƒ±k","Yumu≈üak g√º√ß, ≈üefkatle h√ºkmet.","Zorlamayƒ± bƒ±rak; sabƒ±r eksik."),
"The Hermit":U("ƒ∞√ß arayƒ±≈ü","ƒ∞zolasyon","Yalnƒ±zlƒ±kta i√ß ƒ±≈üƒ±k; ara≈ütƒ±r.","Kopu≈üu fark et; d√ºnyaya d√∂n."),
"Wheel of Fortune":U("D√∂ng√º, fƒ±rsat","Talihsizlik d√∂ng√ºs√º","Zaman d√∂ner; kapƒ± a√ßƒ±lƒ±r.","Aynƒ± d√∂ng√ºye direnme; dersi al."),
"Justice":U("Adalet, denge","Haksƒ±zlƒ±k","Tarafsƒ±z muhakeme; s√∂z√ºnde dur.","Eksik veriyle h√ºk√ºm verme."),
"The Hanged Man":U("Bakƒ±≈ü a√ßƒ±sƒ± deƒüi≈üimi","Tutukluk","Askƒ±da kalƒ±≈ü yeni g√∂r√º≈ü kazandƒ±rƒ±r.","K√∂r fedak√¢rlƒ±k enerjiyi t√ºketir."),
"Death":U("Biti≈ü ve d√∂n√º≈ü√ºm","Deƒüi≈üime diren√ß","Kapanƒ±≈ü=doƒüum; kabuk yenilenir.","Eskiyi bƒ±rakma korkusu ilerletmiyor."),
"Temperance":U("Denge, ƒ±lƒ±mlƒ±lƒ±k","A≈üƒ±rƒ±lƒ±k","Harmanla, √∂l√ß√ºy√º bul.","A≈üƒ±rƒ±lar seni savuruyor."),
"The Devil":U("Baƒü, g√∂lge","Kurtulu≈ü","Baƒüƒ±mlƒ±lƒ±ƒüƒ± g√∂r; sorumluluƒüu al.","Zinciri fark ettin; adƒ±m at."),
"The Tower":U("Ani yƒ±kƒ±m, uyanƒ±≈ü","Geciken kriz","√á√ºr√ºk yapƒ± yƒ±kƒ±lƒ±r; hakikat kalƒ±r.","Ertelenen √ß√∂k√º≈ü daha sert olur."),
"The Star":U("Umut, ilham","≈û√ºphe","Yaran iyile≈üiyor; suya bak.","ƒ∞nancƒ± tazele; k√º√ß√ºk adƒ±m."),
"The Moon":U("Belirsizlik, sezgi","Yanƒ±lsama","Sisli yolda sezgi pusula.","Kuruntuyla ger√ßeƒüi karƒ±≈ütƒ±rma."),
"The Sun":U("Netlik, ba≈üarƒ±","A≈üƒ±rƒ± iyimserlik","√áocuk ne≈üesi; g√∂r√ºn√ºr ba≈üarƒ±.","Ego parlƒ±yor; ekip g√∂lgede kalmasƒ±n."),
"Judgement":U("√áaƒürƒ±, yenilenme","Erteleme","Kendini √ßaƒüƒ±r; eski dosyayƒ± kapat.","Korku y√ºz√ºnden ertelediƒüin karar."),
"The World":U("Tamamlanma","Eksik halka","D√∂ng√º biter; yeni sefer.","Son noktayƒ± koy; a√ßƒ±k u√ß kalmasƒ±n.")};
const SUITS=[{suit:'Cups',up:['Duygu, akƒ±≈ü, baƒü','ƒ∞ki ki≈üi, uyum','Kutlama, topluluk','Duygusal √ßekilme','Hayal kƒ±rƒ±klƒ±ƒüƒ±','Nostalji','Hayaller, se√ßenekler','Veda, yolculuk','Dilek, tatmin','Duygusal tamamlanma']},{suit:'Pentacles',up:['Fƒ±rsat, tohum','Denge, jongl√∂rl√ºk','Ustalƒ±k, i≈übirliƒüi','Tutunma, g√ºvenlik','Yoksunluk, soƒüuk','Payla≈üƒ±m, yardƒ±m','Sabƒ±r, hasat','Ustalƒ±k, emek','√ñz-deƒüer, konfor','Maddi tamamlanma']},{suit:'Swords',up:['Zihin a√ßƒ±klƒ±ƒüƒ±','Kararsƒ±zlƒ±k','Acƒ±, kƒ±rƒ±k kalp','Dinlenme, toparlanma','√áatƒ±≈üma','Ge√ßi≈ü, sƒ±ƒüƒ±nma','Strateji, gizlilik','Sƒ±kƒ±≈ümƒ±≈ü his','Endi≈üe','Zihinsel √ß√∂k√º≈ü']},{suit:'Wands',up:['Kƒ±vƒ±lcƒ±m, ilham','Ufuk planƒ±','Geni≈üleme','Kutlama, temel','Rekabet','Zafer','Savunma','Hƒ±z, haber','Diren√ß','Y√ºk, sorumluluk']}];
const courtUp={Cups:['Hassas haberci','Romantik yolculuk','≈ûefkatli y√∂netici','Duygusal lider'],Pentacles:['√ñƒürenci, pratik adƒ±m','G√ºvenilir ilerleyi≈ü','Kaynak y√∂netimi','Maddi liderlik'],Swords:['Meraklƒ± zihin','Atƒ±lgan eylemci','Keskin karar','Mantƒ±k lideri'],Wands:['Yaratƒ±cƒ± kƒ±vƒ±lcƒ±m','Macera ruhu','Karizmatik y√∂netici','Vizyoner lider']};
const reversedHint={Cups:['A≈üƒ±rƒ± duyarlƒ±lƒ±k','Ka√ßƒ±≈ü√ßƒ±lƒ±k','Manip√ºlasyon','Soƒüukluk'],Pentacles:['√ú≈üenge√ßlik','Oyalama','A√ßg√∂zl√ºl√ºk','ƒ∞nat√ßƒ± kontrol'],Swords:['Dedikodu','D√º≈ü√ºncesiz saldƒ±rƒ±','Zalimlik','Katƒ± zihin'],Wands:['Y√∂ns√ºz heves','D√ºrt√ºsellik','T√ºkenmi≈ülik','Tiranlƒ±k']};
const cards=[];Object.keys(majors).forEach(k=>cards.push({name:k,...majors[k]}));
const R=['Ace','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten'];
SUITS.forEach(({suit,up})=>{up.forEach((txt,i)=>cards.push({name:`${R[i]} of ${suit}`,upright:txt,reversed:reversedHint[suit][Math.min(i,reversedHint[suit].length-1)],longU:txt,longR:reversedHint[suit][Math.min(i,reversedHint[suit].length-1)]}));['Page','Knight','Queen','King'].forEach((r,i)=>cards.push({name:`${r} of ${suit}`,upright:courtUp[suit][i],reversed:reversedHint[suit][i],longU:courtUp[suit][i],longR:reversedHint[suit][i]}));});
const TR={Cups:'Kupa',Pentacles:'Tƒ±lsƒ±m',Swords:'Kƒ±lƒ±√ß',Wands:'Deƒünek',Ace:'As',Two:'ƒ∞ki',Three:'√ú√ß',Four:'D√∂rt',Five:'Be≈ü',Six:'Altƒ±',Seven:'Yedi',Eight:'Sekiz',Nine:'Dokuz',Ten:'On',Page:'U≈üak',Knight:'≈û√∂valye',Queen:'Krali√ße',King:'Kral','The Fool':'Deli','The Magician':'B√ºy√ºc√º','The High Priestess':'Ba≈ürahibe','The Empress':'ƒ∞mparatori√ße','The Emperor':'ƒ∞mparator','The Hierophant':'Aziz','The Lovers':'A≈üƒ±klar','The Chariot':'Sava≈ü Arabasƒ±','Strength':'G√º√ß','The Hermit':'Ermi≈ü','Wheel of Fortune':'Kader √áarkƒ±','Justice':'Adalet','The Hanged Man':'Asƒ±lan Adam','Death':'√ñl√ºm','Temperance':'Denge','The Devil':'≈ûeytan','The Tower':'Kule','The Star':'Yƒ±ldƒ±z','The Moon':'Ay','The Sun':'G√ºne≈ü','Judgement':'Mahkeme','The World':'D√ºnya'};
const trName=name=>name.includes(' of ')?(()=>{const [rank,suit]=name.split(' of ');return `${TR[suit]||suit} ${TR[rank]||rank}`;})():TR[name]||name;
return {cards,trName};})();

/* ---------- App ---------- */
const POSITIONS={one:["Mesaj"],three:["Ge√ßmi≈ü","≈ûimdi","Gelecek"],celtic:["Durum (≈ûimdi)","Engel/√áapraz","Ge√ßmi≈ü Temel","Yakƒ±n Gelecek","Bilin√ß/Hedef","Bilin√ßaltƒ±/K√∂k","√ñneri/Ben","√áevre/Dƒ±≈ü Etki","Umutlar & Korkular","Olasƒ± Sonu√ß"],relation:["Sen","Partner","Baƒü/Dinamik","G√º√ßl√º Yanlar","Zorluklar","Olasƒ± Sonu√ß"]};

const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const el=(t,c)=>{const x=document.createElement(t); if(c)x.className=c; return x};
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}
const slug=name=>name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

const board=qs('#board'), deck=qs('#deck');
const dealBtn=qs('#deal'), spreadSel=qs('#spread'), qInput=qs('#question');
const allowRev=qs('#allowReversed'), autoFlip=qs('#autoFlip'), showImages=qs('#showImages'), pickMode=qs('#pickMode');
const langSel=qs('#lang'), themeSel=qs('#theme');
const summary=qs('#summary'), explain=qs('#explain');
const sharebar=qs('#sharebar'), copyBtn=qs('#copyLink'), waBtn=qs('#shareWa'), xBtn=qs('#shareX'), savePng=qs('#savePng');
const longSec=qs('#longReads'), longBox=qs('#longList');

const KEY='tabirly_tarot_last_v44';
const encodeState=o=>btoa(unescape(encodeURIComponent(JSON.stringify(o))));
const decodeState=s=>JSON.parse(decodeURIComponent(escape(atob(s))));
let LAST_PICKS=[];

function t(name){return langSel.value==='tr'?TAROT.trName(name):name}
function longText(card){return (card.reversed?card.longR:card.longU)}
function shortText(card){return (card.reversed?card.reversed:card.upright)}

function getState(){return{type:spreadSel.value,question:qInput.value.trim(),allowReversed:!!allowRev.checked,autoFlip:!!autoFlip.checked,showImages:!!showImages.checked,pickMode:!!pickMode.checked,lang:langSel.value,theme:themeSel.value,cards:LAST_PICKS.map((p,i)=>({name:p.name,reversed:p.reversed,pos:i}))}};
function saveLocal(st){try{localStorage.setItem(KEY,JSON.stringify(st));}catch(e){}}
function loadLocal(){try{return JSON.parse(localStorage.getItem(KEY)||'null');}catch(e){return null}}
function shareURL(st){const s=encodeState(st);return `${location.origin}${location.pathname}#s=${s}`}

function renderCard(card,type,idx){
  const c=el('div','tarot-card'); if(card.reversed)c.classList.add('is-reversed'); c.setAttribute('role','button'); c.tabIndex=0;
  const back=el('div','face back'); back.innerHTML='<span style="color:#ffd166;font-weight:800">TABIRLY</span>';
  const front=el('div','face front');
  const pos=POSITIONS[type][idx]||`Kart ${idx+1}`;
  const title=t(card.name); const short=shortText(card);
  if(showImages && showImages.checked){ const img=new Image(); img.className='bg'; img.alt=''; img.loading='lazy'; img.src=`img/${slug(card.name)}.jpg`; img.onerror=()=>img.remove(); front.appendChild(img); }
  front.innerHTML+=`
    <div class="pos-badge">${pos}</div>
    <div class="rev-badge">${langSel.value==='tr'?'TERS':'REV'}</div>
    <div class="title">${title}</div>
    <div class="mini">${short}</div>`;
  c.append(back,front);
  c.addEventListener('click',()=>c.classList.toggle('flipped'));
  c.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();c.classList.toggle('flipped');}});
  return c;
}

function renderDeck(){
  deck.innerHTML=''; deck.hidden=!pickMode.checked; if(deck.hidden) return;
  const type=spreadSel.value, need=(POSITIONS[type]||['Mesaj']).length; let picked=0; LAST_PICKS=[]; const d=TAROT.cards.slice(); shuffle(d);
  d.forEach(card=>{
    const c=el('div','tarot-card');
    const back=el('div','face back'); const front=el('div','face front');
    front.innerHTML='<div class="title">Se√ßildi / Picked</div>';
    c.append(back,front);
    c.addEventListener('click',()=>{
      if(c.classList.contains('chosen')||picked>=need) return;
      const reversed=allowRev.checked?(Math.random()<.5):false;
      LAST_PICKS.push({...card,reversed}); picked++; c.classList.add('chosen','flipped');
      if(picked===need) drawFromPicks();
    });
    deck.appendChild(c);
  });
}
function drawFromPicks(){
  const type=spreadSel.value;
  board.innerHTML=''; board.setAttribute('data-type',type);
  LAST_PICKS.forEach((card,i)=> board.appendChild(renderCard(card,type,i)) );
  afterDeal(type);
}

function deal(){
  board.classList.add('shuffle'); setTimeout(()=>board.classList.remove('shuffle'),250);
  board.setAttribute('aria-busy','true'); board.innerHTML='';
  const type=spreadSel.value; board.setAttribute('data-type',type);
  const need=(POSITIONS[type]||['Mesaj']).length;
  if(pickMode.checked){
    renderDeck();
    summary.textContent=(langSel.value==='tr'?`Se√ßmeli mod: ${need} kart se√ß.`:`Pick mode: choose ${need} cards.`);
    explain.hidden=false; board.removeAttribute('aria-busy'); return;
  }
  const d=TAROT.cards.slice(); shuffle(d);
  LAST_PICKS=d.slice(0,need).map(c=>({...c,reversed:allowRev.checked?(Math.random()<.5):false}));
  LAST_PICKS.forEach((card,i)=> board.appendChild(renderCard(card,type,i)) );
  afterDeal(type);
}

function fillLongReads(type){
  longBox.innerHTML='';
  LAST_PICKS.forEach((card,i)=>{
    const div=document.createElement('div');
    div.className='item';
    const pos=POSITIONS[type][i]||`Kart ${i+1}`;
    div.innerHTML = `<div class="title">${pos} ‚Äî ${t(card.name)}</div>
                     <div class="body">${longText(card)}</div>`;
    longBox.appendChild(div);
  });
  longSec.hidden=false;
}

function afterDeal(type){
  const qtxt=qInput.value.trim();
  const mapTR={one:'Tek Kart hazƒ±r.',three:'3 Kart hazƒ±r.',celtic:'Kelt Ha√ßƒ± (10) hazƒ±r.',relation:'ƒ∞li≈üki (6) hazƒ±r.'};
  const mapEN={one:'One Card ready.',three:'3-Card ready.',celtic:'Celtic Cross ready.',relation:'Relationship spread ready.'};
  let txt=(langSel.value==='tr'?mapTR[type]:mapEN[type])||'';
  if(qtxt) txt += (langSel.value==='tr'?` Soru: ‚Äú${qtxt}‚Äù.`:` Question: ‚Äú${qtxt}‚Äù.`);
  summary.textContent = txt + (langSel.value==='tr'?' Kartlara tƒ±klayarak √ßevir.':' Click cards to flip.');
  explain.hidden=false; board.removeAttribute('aria-busy');

  // Uzun yorumlar altta
  fillLongReads(type);

  // Otomatik flip
  if(autoFlip && autoFlip.checked){
    const cards=Array.from(document.querySelectorAll('#board .tarot-card'));
    let i=0; function tick(){ if(i>=cards.length) return; const c=cards[i++]; void c.offsetHeight; c.classList.add('flipped'); setTimeout(tick,150); }
    requestAnimationFrame(()=>setTimeout(tick,120));
  }

  // Kaydet & payla≈ü
  const st=getState(); saveLocal(st);
  const url=shareURL(st); sharebar.hidden=false;
  copyBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(url); copyBtn.textContent=(langSel.value==='tr'?'Kopyalandƒ±':'Copied'); setTimeout(()=>copyBtn.textContent=(langSel.value==='tr'?'Linki kopyala':'Copy link'),1200);}catch(e){ alert(url);} };
  waBtn.onclick=()=>{ const t=encodeURIComponent(`${langSel.value==='tr'?'Tarot a√ßƒ±lƒ±mƒ±m:':'My tarot spread:'}\n${url}`); window.open(`https://wa.me/?text=${t}`,'_blank'); };
  xBtn.onclick =()=>{ const t=encodeURIComponent(`Tabirly Tarot ‚Äî ${url}`); window.open(`https://twitter.com/intent/tweet?text=${t}`,'_blank'); };
}

savePng?.addEventListener('click',async()=>{ try{ const node=board; const canvas=await html2canvas(node,{backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--bg')||'#0b0d12',useCORS:true,scale:2}); const link=document.createElement('a'); link.download='tabirly-tarot.png'; link.href=canvas.toDataURL('image/png'); link.click(); }catch(e){ alert('G√∂rsel olu≈üturulamadƒ± :(');} });

function applyTheme(){ document.documentElement.setAttribute('data-theme', themeSel.value); saveLocal(getState()); }
themeSel.addEventListener('change',applyTheme);
langSel.addEventListener('change',()=>{ const st=getState(); saveLocal(st); if(LAST_PICKS.length){ drawFromPicks(); fillLongReads(spreadSel.value); }});

dealBtn.addEventListener('click',deal);
pickMode.addEventListener('change',()=>{ if(pickMode.checked){ renderDeck(); } else { deck.hidden=true; }});

(function init(){
  const hash=new URLSearchParams(location.hash.slice(1)); let st=null;
  if(hash.get('s')){ try{ st=decodeState(hash.get('s')); }catch(e){} }
  if(!st){ st=loadLocal(); }
  if(st){
    spreadSel.value=st.type||'one'; qInput.value=st.question||'';
    allowRev.checked=!!st.allowReversed; autoFlip.checked=!!st.autoFlip;
    showImages.checked=!!st.showImages; pickMode.checked=!!st.pickMode;
    langSel.value=st.lang||'tr'; themeSel.value=st.theme||'dark'; applyTheme();
  }
  if(st && st.cards && st.cards.length){
    board.setAttribute('data-type',st.type);
    LAST_PICKS=st.cards.map(k=>{const base=TAROT.cards.find(x=>x.name===k.name)||TAROT.cards[0]; return {...base,reversed:!!k.reversed};});
    LAST_PICKS.forEach((card,i)=> board.appendChild(renderCard(card, st.type, i)) );
    let txt=(langSel.value==='tr'?(st.type==='three'?'3 Kart (y√ºkledi).':st.type==='celtic'?'Kelt Ha√ßƒ± (y√ºkledi).':st.type==='relation'?'ƒ∞li≈üki (y√ºkledi).':'Tek Kart (y√ºkledi).'):(st.type==='three'?'3-Card (loaded).':st.type==='celtic'?'Celtic Cross (loaded).':st.type==='relation'?'Relationship (loaded).':'One Card (loaded).'));
    if(st.question) txt += (langSel.value==='tr'?` Soru: ‚Äú${st.question}‚Äù.`:` Question: ‚Äú${st.question}‚Äù.`);
    summary.textContent=txt+(langSel.value==='tr'?' Kartlara tƒ±klayarak √ßevir.':' Click cards to flip.');
    explain.hidden=false; sharebar.hidden=false;
    fillLongReads(st.type);
    if(pickMode.checked) renderDeck();
  }
})();
</script>
</body>
</html>
