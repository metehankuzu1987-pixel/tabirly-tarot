<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tabirly | Tarot Aracı</title>
<meta name="description" content="Tarot açılımları: Tek Kart, 3 Kart, Kelt Haçı, İlişki. Seçmeli mod, paylaşım, yerel kayıt, PNG indirme, tema." />
<meta property="og:title" content="Tabirly | Tarot Aracı" />
<meta property="og:description" content="Tek Kart, 3 Kart, Kelt Haçı, İlişki — sonucu link ya da görsel olarak paylaş." />
<meta property="og:type" content="website" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%237f5af0'/><stop offset='1' stop-color='%23ffd166'/></linearGradient></defs><rect rx='14' width='64' height='64' fill='url(%23g)'/></svg>">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<style>
:root{
  --bg:#0e1118; --bg2:#111828; --card:#161b2a;
  --ink:#eef3ff; --muted:#9fb0c7;
  --acc1:#7fb8ff; --acc2:#79e9d3; --acc3:#b79cff;
  --radius:14px; --gap:12px; --shadow:0 10px 28px rgba(0,0,0,.35);
  --card-pad:10px; --title-size:14px; --mini-size:11px; --badge-size:11px;
}
*{box-sizing:border-box}
body{
  margin:0;
  background: radial-gradient(1000px 700px at 15% -10%, var(--bg2) 0%, var(--bg) 55%), var(--bg);
  color:var(--ink);
  font:15px/1.6 system-ui, Inter, Roboto, Arial, sans-serif;
}
.wrap{max-width:1000px;margin:24px auto;padding:0 12px 64px}
header{display:flex;gap:12px;align-items:center;margin:0 0 12px}
.hgroup h1{margin:0;font-size:20px}
.hgroup p{margin:.25rem 0 0;color:var(--muted);font-size:13px}

.panel{background:rgba(22,27,42,.65);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
.controls{display:grid;grid-template-columns:1fr 1fr auto;gap:var(--gap);align-items:end}
@media(max-width:700px){.controls{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
select,input{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0f1423;color:var(--ink);padding:8px 9px;font:inherit}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}

.btn{border:0;border-radius:12px;padding:10px 14px;background:linear-gradient(180deg, var(--acc1), var(--acc2));color:#0c0f14;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(127,184,255,.25)}
.btn.small{padding:7px 10px;font-weight:600}

/* Izgara + Kart */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:var(--gap);margin:14px 0;justify-items:center}
#board[data-type="celtic"]{grid-template-columns:repeat(5,1fr)}
@media (max-width:900px){#board[data-type="celtic"]{grid-template-columns:repeat(3,1fr)}}
#board[data-type="relation"]{grid-template-columns:repeat(3,1fr)}

.tarot-card{
  position:relative; aspect-ratio:3/5; border-radius:12px;
  transform-style:preserve-3d; transition:transform .65s cubic-bezier(.2,.6,.2,1);
  box-shadow:var(--shadow); cursor:pointer; will-change:transform;
  width:100%; max-width:100px; justify-self:center;
}
.tarot-card.flipped{transform:rotateY(180deg)}
.tarot-card .face{position:absolute;inset:0;display:grid;place-items:center;backface-visibility:hidden;border-radius:12px;overflow:hidden}
.tarot-card .back{
  background:
    linear-gradient(135deg, rgba(127,184,255,.18), rgba(121,233,211,.12)),
    repeating-radial-gradient(circle at 50% 38%, #202744 0 7px, #1a2240 7px 14px);
}
.tarot-card .front{
  transform:rotateY(180deg);
  background:var(--card);
  padding:var(--card-pad);
  text-align:center;
  border:1px solid rgba(255,255,255,.08);
  position:relative;
}
.title{font-weight:800;margin-top:6px;font-size:var(--title-size)}
.mini{font-size:var(--mini-size);color:var(--muted);margin-top:3px;white-space:pre-wrap;overflow-wrap:break-word}

.pos-badge,.rev-badge{position:absolute;top:6px;padding:3px 7px;border-radius:9px;font-size:var(--badge-size)}
.pos-badge{left:6px;background:rgba(0,0,0,.45);color:#fff}
.rev-badge{right:6px;background:rgba(239,71,111,.92);color:#fff;display:none}
.tarot-card.is-reversed .rev-badge{display:inline-block}

/* Animasyon */
@keyframes shuffleSpin{0%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}100%{transform:rotate(0)}}
.shuffle .tarot-card{animation:shuffleSpin .22s ease both}

footer{margin-top:22px;color:var(--muted);font-size:11px;text-align:center}
.inline{display:flex;align-items:center;gap:8px}
.muted{color:var(--muted);font-size:12px}

/* Açık tema */
[data-theme="light"]{
  --bg:#f4f7ff; --bg2:#ecf4ff; --card:#ffffff; --ink:#0b0d12; --muted:#4a5a70;
  --shadow:0 8px 20px rgba(15,23,42,.08);
}
[data-theme="light"] body{
  background: radial-gradient(1000px 700px at 18% -10%, var(--bg2) 0%, var(--bg) 60%), var(--bg);
}
[data-theme="light"] .panel{background:#ffffffcc;border:1px solid rgba(15,23,42,.06)}
[data-theme="light"] select, [data-theme="light"] input{background:#ffffff;color:#0b0d12;border:1px solid rgba(15,23,42,.12)}
[data-theme="light"] .btn{background:linear-gradient(180deg, var(--acc1), var(--acc3));color:#091016;box-shadow:0 6px 16px rgba(181,209,255,.35)}
[data-theme="light"] .tarot-card .back{
  background:
    linear-gradient(135deg, rgba(179,216,255,.45), rgba(214,198,255,.35)),
    repeating-radial-gradient(circle at 50% 38%, #e8efff 0 7px, #dee9ff 7px 14px);
}
[data-theme="light"] .tarot-card .front{background:linear-gradient(180deg,#ffffff,#f7f9ff);border:1px solid rgba(15,23,42,.08)}
[data-theme="light"] .pos-badge{background:rgba(9,16,22,.08);color:#091016}

/* Görsel katmanlama */
.tarot-card .front{ position:relative; display:flex; flex-direction:column; justify-content:flex-end; align-items:center; }
.tarot-card.has-img .front{ background:transparent !important; }
.tarot-card .front img.bg{
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:cover; object-position:center;
  opacity:.42; filter:contrast(1.05) saturate(1.05) brightness(.9);
  z-index:1 !important; pointer-events:none; transform:translateZ(0);
}
[data-theme="light"] .tarot-card .front img.bg{ opacity:.35; }
.tarot-card .front > :not(img){ position:relative; z-index:2 !important; }

@media (max-width:700px){.tarot-card{max-width:140px}}

/* PICK MODE (yalnızca deck görünümü) */
.tarot-card.in-deck .front{ display:none; }
.tarot-card.in-deck .back{ position:relative; }
.tarot-card.in-deck .back::after{
  content:'Seçildi';
  position:absolute; top:6px; left:6px;
  padding:3px 7px; border-radius:9px; font-size:11px;
  background:rgba(0,0,0,.45); color:#fff; display:none;
}

/* Deck arka yüzü board ile aynı renk olsun */
#deck .tarot-card .back {
  background:
    linear-gradient(135deg, rgba(127,184,255,.18), rgba(121,233,211,.12)),
    repeating-radial-gradient(circle at 50% 38%, #202744 0 7px, #1a2240 7px 14px);
}
[data-theme="light"] #deck .tarot-card .back {
  background:
    linear-gradient(135deg, rgba(179,216,255,.45), rgba(214,198,255,.35)),
    repeating-radial-gradient(circle at 50% 38%, #e8efff 0 7px, #dee9ff 7px 14px);
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="hgroup">
        <h1>Tabirly Tarot</h1>
        <p>Tek Kart, 3 Kart, Kelt Haçı, İlişki • Seçmeli mod • Paylaş/PNG • Yerel kayıt • Tema</p>
      </div>
    </header>

    <section class="panel" aria-label="Açılım ayarları">
      <div class="controls">
        <div>
          <label for="spread">Açılım</label>
          <select id="spread">
            <option value="one">Tek Kart</option>
            <option value="three">3 Kart (Geçmiş–Şimdi–Gelecek)</option>
            <option value="celtic">Kelt Haçı (10 kart)</option>
            <option value="relation">İlişki (6 kart)</option>
          </select>
        </div>
        <div>
          <label for="question">Soru (isteğe bağlı)</label>
          <input id="question" type="text" placeholder="Örn. İlişkimde nasıl ilerlemeliyim?">
        </div>
        <div>
          <button id="deal" class="btn">Kartları çek</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="inline"><input type="checkbox" id="allowReversed" checked style="accent-color:#ffd166"/> Ters kart</label>
        <label class="inline"><input type="checkbox" id="autoFlip" checked style="accent-color:#ffd166"/> Otomatik flip</label>
        <label class="inline"><input type="checkbox" id="showImages" style="accent-color:#ffd166"/> Kart görselleri</label>
        <label class="inline"><input type="checkbox" id="pickMode" style="accent-color:#ffd166"/> Seçmeli mod</label>

        <label class="inline">Tema:
          <select id="theme" class="compact-select">
            <option value="dark">Koyu</option>
            <option value="light">Açık</option>
          </select>
        </label>
      </div>
    </section>

    <section class="panel" id="extras">
      <div class="row" id="sharebar" hidden>
        <button class="btn small" id="copyLink">Linki kopyala</button>
        <button class="btn small secondary" id="shareWa">WhatsApp</button>
        <button class="btn small secondary" id="shareX">X / Twitter</button>
        <button class="btn small" id="savePng">Görsel indir (PNG)</button>
      </div>
    </section>

    <!-- Sayaç + Deste -->
    <div id="pickCounter" class="muted" style="margin:6px 0; display:none;"></div>
    <section id="deck" class="grid" hidden aria-label="Deste"></section>

    <section id="board" class="grid" aria-live="polite" aria-busy="false"></section>

    <section id="explain" class="panel" hidden>
      <p id="summary">Kartlara tıklayarak çevir. Ayarlardan ters kart ve otomatik flip’i yönet. Seçmeli modda, desteden gerekli sayıda kartı seç.</p>
    </section>

    <section id="longReads" class="panel" hidden>
      <h3>Yorumlar</h3>
      <div id="longList"></div>
    </section>

    <footer><p>© Tabirly — Tarot Aracı</p></footer>
  </div>

<script>
/* ---------- Tarot veri seti (kısa TR) ---------- */
const TAROT=(()=>{
  const U=(u,r)=>({upright:u,reversed:r,longU:u,longR:r});
  const majors={
    "The Fool":U("Başlangıç, akışa güven","Düşüncesiz risk"),
    "The Magician":U("Niyet, odak, eylem","Dağınık enerji, yanılsama"),
    "The High Priestess":U("Sezgi, sır","Gizlilik, kopukluk"),
    "The Empress":U("Bereket, bakım, yaratım","Aşırı koruma, tıkanma"),
    "The Emperor":U("Düzen, yapı, otorite","Katılık, kontrol"),
    "The Hierophant":U("Gelenek, rehberlik","Kör uyum, dogma"),
    "The Lovers":U("Seçim, uyum, bağ","Kararsızlık, uyumsuzluk"),
    "The Chariot":U("İrade, yön, zafer","Dengesizlik"),
    "Strength":U("Sakin güç, sabır","Sabırsızlık"),
    "The Hermit":U("İç arayış","İzolasyon"),
    "Wheel of Fortune":U("Döngüler, fırsat","Sıkışmış döngü"),
    "Justice":U("Adalet, denge","Haksızlık"),
    "The Hanged Man":U("Yeni bakış açısı","Tutukluk"),
    "Death":U("Bitiş ve dönüşüm","Değişime direnç"),
    "Temperance":U("Denge, ılımlılık","Aşırılık"),
    "The Devil":U("Bağ, gölge","Kurtuluş"),
    "The Tower":U("Ansızın yıkım, uyanış","Geciken kriz"),
    "The Star":U("Umut, ilham","Şüphe"),
    "The Moon":U("Belirsizlik, sezgi","Yanılsama"),
    "The Sun":U("Netlik, başarı","Aşırı iyimserlik"),
    "Judgement":U("Çağrı, yenilenme","Erteleme"),
    "The World":U("Tamamlanma","Eksik halka")
  };
  const SUITS=[
    {suit:'Cups',up:['Duygu, akış, bağ','İki kişi, uyum','Kutlama, topluluk','Duygusal çekilme','Hayal kırıklığı','Nostalji','Hayaller, seçenekler','Veda, yolculuk','Dilek, tatmin','Duygusal tamamlanma']},
    {suit:'Pentacles',up:['Fırsat, tohum','Denge, jonglörlük','Ustalık, işbirliği','Tutunma, güvenlik','Yoksunluk, soğuk','Paylaşım, yardım','Sabır, hasat','Ustalık, emek','Öz-değer, konfor','Maddi tamamlanma']},
    {suit:'Swords',up:['Zihin açıklığı','Kararsızlık','Kırık kalp','Dinlenme, toparlanma','Çatışma','Geçiş, sığınma','Strateji, gizlilik','Sıkışmış his','Endişe','Dip nokta']},
    {suit:'Wands',up:['Kıvılcım, ilham','Ufuk planı','Genişleme','Kutlama, temel','Rekabet','Zafer','Savunma','Hız, haber','Direnç','Yük, sorumluluk']}
  ];
  const courtUp={
    Cups:['Hassas haberci','Romantik yolculuk','Şefkatli yönetici','Duygusal lider'],
    Pentacles:['Öğrenci, pratik adım','Güvenilir ilerleyiş','Kaynak yöneticisi','Maddi lider'],
    Swords:['Meraklı zihin','Atılgan eylemci','Keskin karar','Mantık lideri'],
    Wands:['Yaratıcı kıvılcım','Macera ruhu','Karizmatik yönetici','Vizyoner lider']
  };
  const reversedHint={
    Cups:['Aşırı duyarlılık','Kaçışçılık','Manipülasyon','Soğukluk'],
    Pentacles:['Üşengeçlik','Oyalama','Açgözlülük','İnatçı kontrol'],
    Swords:['Dedikodu','Düşüncesiz saldırı','Zalimlik','Katı zihin'],
    Wands:['Yönsüz heves','Dürtüsellik','Tükenmişlik','Tiranlık']
  };
  const cards=[];
  Object.keys(majors).forEach(k=>cards.push({name:k,...majors[k]}));
  const R=['Ace','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten'];
  SUITS.forEach(({suit,up})=>{
    up.forEach((txt,i)=>cards.push({name:`${R[i]} of ${suit}`,upright:txt,reversed:reversedHint[suit][Math.min(i,reversedHint[suit].length-1)],longU:txt,longR:reversedHint[suit][Math.min(i,reversedHint[suit].length-1)]}));
    ['Page','Knight','Queen','King'].forEach((r,i)=>cards.push({name:`${r} of ${suit}`,upright:courtUp[suit][i],reversed:reversedHint[suit][i],longU:courtUp[suit][i],longR:reversedHint[suit][i]}));
  });
  return {cards};
})();

/* ---------- Uygulama ---------- */
const POSITIONS={
  one:["Mesaj"],
  three:["Geçmiş","Şimdi","Gelecek"],
  celtic:["Durum (Şimdi)","Engel/Çapraz","Geçmiş Temel","Yakın Gelecek","Bilinç/Hedef","Bilinçaltı/Kök","Öneri/Ben","Çevre/Dış Etki","Umutlar & Korkular","Olası Sonuç"],
  relation:["Sen","Partner","Bağ/Dinamik","Güçlü Yanlar","Zorluklar","Olası Sonuç"]
};

const qs=s=>document.querySelector(s);
const el=(t,c)=>{const x=document.createElement(t); if(c)x.className=c; return x};
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}
const slug=name=>name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
function asset(relPath){ return new URL(relPath, location.href).href; }

const board=qs('#board'), deck=qs('#deck');
const dealBtn=qs('#deal'), spreadSel=qs('#spread'), qInput=qs('#question');
const allowRev=qs('#allowReversed'), autoFlip=qs('#autoFlip'), showImages=qs('#showImages'), pickMode=qs('#pickMode');
const themeSel=qs('#theme');
const summary=qs('#summary'), explain=qs('#explain');
const sharebar=qs('#sharebar'), copyBtn=qs('#copyLink'), waBtn=qs('#shareWa'), xBtn=qs('#shareX'), savePng=qs('#savePng');
const longSec=qs('#longReads'), longBox=qs('#longList');
const pickCounterEl=document.getElementById('pickCounter');

const KEY='tabirly_tarot_tr_v1';
const encodeState=o=>btoa(unescape(encodeURIComponent(JSON.stringify(o))));
const decodeState=s=>JSON.parse(decodeURIComponent(escape(atob(s))));
let LAST_PICKS=[];

function longText(card){return (card?.reversed?card.longR:card?.longU) || '';}
function shortText(card){return (card?.reversed?card.reversed:card?.upright) || ''; }
function getPositions(type){ return POSITIONS[type] || ['Mesaj']; }

function getState(){return{
  type:spreadSel.value,question:qInput.value.trim(),
  allowReversed:!!allowRev.checked,autoFlip:!!autoFlip.checked,
  showImages:!!showImages.checked,pickMode:!!pickMode.checked,
  theme:themeSel.value,
  cards:LAST_PICKS.map((p,i)=>({name:p.name,reversed:!!p.reversed,pos:i}))
};}
function saveLocal(st){try{localStorage.setItem(KEY,JSON.stringify(st));}catch(e){}}
function loadLocal(){try{return JSON.parse(localStorage.getItem(KEY)||'null');}catch(e){return null}}
function shareURL(st){ const s=encodeState(st); const base=location.href.split('#')[0].split('?')[0]; return `${base}#s=${s}`; }

/* ---- Seçim sayacı ---- */
function updatePickCounter(picked, need){
  if(!pickMode.checked){ pickCounterEl.style.display='none'; return; }
  pickCounterEl.style.display='block';
  pickCounterEl.textContent = `Seçildi ${picked}/${need}`;
}

function renderCard(card,type,idx){
  const c=el('div','tarot-card'); 
  if(card.reversed) c.classList.add('is-reversed'); 
  c.setAttribute('role','button'); c.tabIndex=0;

  const back=el('div','face back'); back.innerHTML='<span style="color:#ffd166;font-weight:800">TABIRLY</span>';
  const front=el('div','face front');

  const pos=getPositions(type)[idx]||`Kart ${idx+1}`;
  const title=card.name; 
  const short=shortText(card);

  if(showImages && showImages.checked){
    const img=new Image();
    img.className='bg'; img.alt=''; img.loading='eager'; img.decoding='async';
    img.src=asset(`img/${slug(card.name)}.jpg`);
    img.onerror=()=>img.remove();
    front.appendChild(img);
    c.classList.add('has-img');
  }

  const posEl=el('div','pos-badge'); posEl.textContent=pos; front.appendChild(posEl);
  const revEl=el('div','rev-badge'); revEl.textContent='TERS'; front.appendChild(revEl);
  const ttlEl=el('div','title'); ttlEl.textContent=title; front.appendChild(ttlEl);
  const miniEl=el('div','mini'); miniEl.textContent=short; front.appendChild(miniEl);

  c.append(back,front);
  c.addEventListener('click',()=>c.classList.toggle('flipped'));
  c.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();c.classList.toggle('flipped');}});
  return c;
}

/* ---- SEÇMELİ MOD: DESTE ---- */
function renderDeck(){
  deck.innerHTML='';
  deck.hidden = !pickMode.checked;
  if (deck.hidden) { pickCounterEl.style.display='none'; return; }

  const type = spreadSel.value;
  const need = getPositions(type).length;

  let picked = 0;
  LAST_PICKS = [];
  updatePickCounter(picked, need);

  const d = TAROT.cards.slice();
  shuffle(d);

  d.forEach(card=>{
    const c = el('div','tarot-card in-deck');
    const back = el('div','face back');
    const front = el('div','face front');  // CSS gereği görünmez
    c.append(back, front);

    c.addEventListener('click', ()=>{
      if (c.classList.contains('selected') || picked >= need) return;
      const reversed = allowRev.checked ? (Math.random() < .5) : false;
      LAST_PICKS.push({...card, reversed});
      picked++;
      c.classList.add('selected');
      updatePickCounter(picked, need);
      if (picked === need){
        pickCounterEl.style.display='none';
        drawFromPicks();
      }
    });

    deck.appendChild(c);
  });
}

function drawFromPicks(){
  const type=spreadSel.value;
  board.innerHTML=''; board.setAttribute('data-type',type);
  LAST_PICKS.forEach((card,i)=> board.appendChild(renderCard(card,type,i)) );
  afterDeal(type);
}

function deal(){
  board.classList.add('shuffle'); setTimeout(()=>board.classList.remove('shuffle'),250);
  board.setAttribute('aria-busy','true'); board.innerHTML='';
  const type=spreadSel.value; board.setAttribute('data-type',type);

  if (pickMode.checked){
    renderDeck();
    const need = getPositions(type).length;
    summary.textContent=`Seçmeli mod: ${need} kart seç.`;
    explain.hidden=false; board.removeAttribute('aria-busy');
    return;
  }

  const need=getPositions(type).length;
  const d=TAROT.cards.slice(); shuffle(d);
  LAST_PICKS=d.slice(0,need).map(c=>({...c,reversed:allowRev.checked?(Math.random()<.5):false}));
  LAST_PICKS.forEach((card,i)=> board.appendChild(renderCard(card,type,i)) );
  afterDeal(type);
}

function fillLongReads(type){
  longBox.innerHTML='';
  LAST_PICKS.forEach((card,i)=>{
    const div=document.createElement('div');
    div.className='item';
    const pos=getPositions(type)[i]||`Kart ${i+1}`;
    const titleEl=el('div','title'); titleEl.textContent=`${pos} — ${card.name}`;
    const bodyEl=el('div','body');  bodyEl.textContent=longText(card);
    div.appendChild(titleEl); div.appendChild(bodyEl);
    longBox.appendChild(div);
  });
  longSec.hidden=false;
}

function afterDeal(type){
  const qtxt=qInput.value.trim();
  const mapTR={one:'Tek Kart hazır.',three:'3 Kart hazır.',celtic:'Kelt Haçı hazır.',relation:'İlişki açılımı hazır.'};
  let txt=mapTR[type]||'';
  if(qtxt) txt += ` Soru: “${qtxt}”.`;
  summary.textContent = txt + ' Kartlara tıklayarak çevir.';
  explain.hidden=false; board.removeAttribute('aria-busy');

  fillLongReads(type);

  if(autoFlip && autoFlip.checked){
    const need=getPositions(type).length;
    const cards=Array.from(board.querySelectorAll('.tarot-card'));
    let i=0; const total=Math.min(cards.length,need);
    const tick=()=>{ if(i>=total) return; const c=cards[i++]; void c.offsetHeight; c.classList.add('flipped'); setTimeout(tick,150); };
    if(total>0) requestAnimationFrame(()=>setTimeout(tick,120));
  }

  const st=getState(); saveLocal(st);
  const url=shareURL(st); sharebar.hidden=false;
  copyBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(url); copyBtn.textContent='Kopyalandı'; setTimeout(()=>copyBtn.textContent='Linki kopyala',1200);}catch(e){ alert(url);} };
  waBtn.onclick=()=>{ const t=encodeURIComponent(`Tarot açılımım:\n${url}`); window.open(`https://wa.me/?text=${t}`,'_blank'); };
  xBtn.onclick =()=>{ const t=encodeURIComponent(`Tabirly Tarot — ${url}`); window.open(`https://twitter.com/intent/tweet?text=${t}`,'_blank'); };
}

savePng?.addEventListener('click',async()=>{
  try{
    const node=board;
    const canvas=await html2canvas(node,{backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--bg')||'#0b0d12',useCORS:true,scale:2});
    const link=document.createElement('a'); link.download='tabirly-tarot.png'; link.href=canvas.toDataURL('image/png'); link.click();
  }catch(e){ alert('Görsel oluşturulamadı :('); }
});

function applyTheme(){ document.documentElement.setAttribute('data-theme', themeSel.value); saveLocal(getState()); }
themeSel.addEventListener('change',applyTheme);

/* reaktif deck */
pickMode.addEventListener('change',()=>{ 
  if (pickMode.checked){ board.innerHTML=''; renderDeck(); } 
  else { deck.hidden=true; pickCounterEl.style.display='none'; } 
});
spreadSel.addEventListener('change',()=>{ if (pickMode.checked) renderDeck(); });

dealBtn.addEventListener('click',deal);

(function init(){
  const hash=new URLSearchParams(location.hash.slice(1)); let st=null;
  if(hash.get('s')){ try{ st=decodeState(hash.get('s')); }catch(e){} }
  if(!st){ st=loadLocal(); }
  if(st){
    spreadSel.value=st.type||'one'; qInput.value=st.question||'';
    allowRev.checked=!!st.allowReversed; autoFlip.checked=!!st.autoFlip;
    showImages.checked=!!st.showImages; pickMode.checked=!!st.pickMode;
    themeSel.value=st.theme||'dark'; applyTheme();
  }
  if(pickMode.checked) renderDeck();
  if(st && st.cards && st.cards.length){
    board.setAttribute('data-type',st.type);
    LAST_PICKS=st.cards.map(k=>{const base=TAROT.cards.find(x=>x.name===k.name)||TAROT.cards[0]; return {...base,reversed:!!k.reversed};});
    LAST_PICKS.forEach((card,i)=> board.appendChild(renderCard(card, st.type, i)) );
    fillLongReads(st.type);
    summary.textContent=(st.type==='three'?'3 Kart (yüklendi).':st.type==='celtic'?'Kelt Haçı (yüklendi).':st.type==='relation'?'İlişki (yüklendi).':'Tek Kart (yüklendi).')+(st.question?` Soru: “${st.question}”.`: '')+' Kartlara tıklayarak çevir.';
    explain.hidden=false; sharebar.hidden=false;
  }
})();
</script>
</body>
</html>
